<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZXS Cloudmoon Tester</title>
    <link rel="stylesheet" href="index.css">
    <script src="https://cdn.jsdelivr.net/npm/dreamland"></script>
    <script src="baremux/index.js"></script>
    <script src="scram/scramjet.all.js"></script>
</head>

<body>
    <div class="container">
        <h1>ZXS PROXY TESTER</h1>
        <p class="subtitle">CloudMoon Bypass Engine (Alpha)</p>

        <div class="input-group">
            <input type="text" id="url-input" placeholder="https://cloudmoonapp.com" value="https://cloudmoonapp.com">
        </div>
        <button class="btn" onclick="launchProxy()">Launch Stealth Instance</button>

        <div class="game-grid">
            <div class="game-card" onclick="launchUrl('https://cloudmoonapp.com')">
                <span>üåô</span>
                <p>CloudMoon</p>
            </div>
            <div class="game-card" onclick="launchUrl('https://roblox.com')">
                <span>üéÆ</span>
                <p>Roblox</p>
            </div>
            <div class="game-card" onclick="launchUrl('https://poki.com')">
                <span>üïπÔ∏è</span>
                <p>Poki Games</p>
            </div>
            <div class="game-card" onclick="launchUrl('https://google.com')">
                <span>üîç</span>
                <p>Google</p>
            </div>
        </div>

        <div class="settings">
            <div class="status">
                <div class="status-dot" id="engine-dot"></div>
                <span id="engine-status">Detecting Engine...</span>
            </div>
            <div class="status">
                v1.6.1-GH
            </div>
            <div class="status">
                Wisp: <span id="wisp-display">anura.pro</span>
            </div>
        </div>
    </div>

    <!-- Proxy Overlay -->
    <div id="proxy-overlay">
        <div class="browser-toolbar">
            <div class="nav-controls">
                <button class="nav-btn" title="Back" onclick="goBack()">‚Üê</button>
                <button class="nav-btn" title="Forward" onclick="goForward()">‚Üí</button>
                <button class="nav-btn" title="Reload" onclick="reloadPage()">‚Üª</button>
            </div>

            <div class="address-bar-container">
                <span class="url-icon">üîí</span>
                <input type="text" class="browser-input" id="browser-address-bar" placeholder="Search or enter URL"
                    onkeyup="if(event.key === 'Enter') navigateToUrl()">
            </div>

            <button class="nav-btn" title="Fix Login/Google Issues" style="color: #fbd38d;" onclick="syncIdentity()">üîë
                Sync</button>
            <button class="exit-btn" onclick="closeProxy()">Exit</button>
        </div>
        <div id="iframe-container"></div>
    </div>

    <script>
        var activeFrame = null;
        const { ScramjetController } = $scramjetLoadController();

        // Path detection (v1.6.1)
        const isGH = location.hostname.includes('github.io');
        const pathSegments = window.location.pathname.split('/').filter(s => s);
        const repoName = isGH ? pathSegments[0] : '';
        const root = isGH ? ("/" + repoName + "/") : "/";

        const scramjet = new ScramjetController({
            prefix: root + "scram/",
            files: {
                wasm: root + "scram/scramjet.wasm.wasm",
                all: root + "scram/scramjet.all.js",
                sync: root + "scram/scramjet.sync.js",
            },
        });

        async function init() {
            try {
                // Initialize controller
                await scramjet.init();

                // Register Service Worker
                if ("serviceWorker" in navigator) {
                    await navigator.serviceWorker.register(root + "sw.js", { scope: root });
                    console.log("ZXS SW Registered.");
                }

                // Connect BareMux
                const connection = new BareMux.BareMuxConnection(root + "baremux/worker.js");
                // Use explicit port for Epoxy
                const wispUrl = "wss://anura.pro:443/";

                await connection.setTransport(root + "epoxy/index.mjs", [{ wisp: wispUrl }]);
                console.log("BareMux Connection Stable.");

                document.getElementById('engine-status').innerText = "Engine Stable";
                document.getElementById('engine-dot').style.backgroundColor = "#22c55e";
                document.getElementById('wisp-display').innerText = "anura.pro";
            } catch (err) {
                console.error("Boot Failure:", err);
                document.getElementById('engine-status').innerText = "Engine Error";
                document.getElementById('engine-dot').style.backgroundColor = "#ef4444";
                document.querySelector('.subtitle').innerHTML = `<span style="color:red">ERROR: ${err.message}</span>`;
            }
        }

        init();

        function launchProxy() {
            const url = document.getElementById('url-input').value;
            launchUrl(url);
        }

        function launchUrl(url) {
            if (!url) return;
            if (!url.startsWith('http')) url = 'https://' + url;

            document.getElementById('proxy-overlay').style.display = 'flex';
            document.getElementById('browser-address-bar').value = url;

            const container = document.getElementById('iframe-container');
            container.innerHTML = '';

            console.log("Launching instance:", url);
            activeFrame = scramjet.createFrame();
            container.appendChild(activeFrame.frame);

            activeFrame.frame.style.width = '100%';
            activeFrame.frame.style.height = '100%';
            activeFrame.frame.style.border = 'none';

            activeFrame.addEventListener("urlchange", (e) => {
                if (e.url) document.getElementById('browser-address-bar').value = e.url;
            });

            activeFrame.go(url);
        }

        function navigateToUrl() {
            const val = document.getElementById('browser-address-bar').value;
            if (activeFrame) {
                let target = val;
                if (!target.startsWith('http') && target.includes('.')) {
                    target = 'https://' + target;
                } else if (!target.startsWith('http')) {
                    target = 'https://www.google.com/search?q=' + encodeURIComponent(target);
                }
                activeFrame.go(target);
            }
        }

        function goBack() { if (activeFrame) activeFrame.back(); }
        function goForward() { if (activeFrame) activeFrame.forward(); }
        function reloadPage() { if (activeFrame) activeFrame.reload(); }

        function syncIdentity() {
            const googleLogin = "https://accounts.google.com/ServiceLogin?hl=en";
            const proxiedUrl = scramjet.encodeUrl(googleLogin);
            window.open(proxiedUrl, "_blank", "width=800,height=700");
            alert("Stealth Login Tab opened. Sign in there, then reload your game.");
        }

        function closeProxy() {
            if (confirm("Close the stealth browser?")) {
                document.getElementById('proxy-overlay').style.display = 'none';
                document.getElementById('iframe-container').innerHTML = '';
                activeFrame = null;
            }
        }
    </script>
</body>

</html>
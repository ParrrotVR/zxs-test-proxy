<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZXS Cloudmoon Tester</title>
    <link rel="stylesheet" href="index.css">
    <script src="https://cdn.jsdelivr.net/npm/dreamland"></script>
    <script src="baremux/index.js"></script>
    <script src="scram/scramjet.all.js"></script>
    <script src="assets/config.js"></script>
</head>

<body>
    <div class="container">
        <h1>ZXS PROXY TESTER</h1>
        <p class="subtitle">CloudMoon Bypass Engine (Alpha)</p>

        <div class="input-group">
            <input type="text" id="url-input" placeholder="https://cloudmoonapp.com" value="https://cloudmoonapp.com">
        </div>
        <button class="btn" onclick="launchProxy()">Launch Stealth Instance</button>

        <div class="game-grid">
            <div class="game-card" onclick="launchUrl('https://cloudmoonapp.com')">
                <span>üåô</span>
                <p>CloudMoon</p>
            </div>
            <div class="game-card" onclick="launchUrl('https://roblox.com')">
                <span>üéÆ</span>
                <p>Roblox</p>
            </div>
            <div class="game-card" onclick="launchUrl('https://poki.com')">
                <span>üïπÔ∏è</span>
                <p>Poki Games</p>
            </div>
            <div class="game-card" onclick="launchUrl('https://google.com')">
                <span>üîç</span>
                <p>Google</p>
            </div>
        </div>

        <div class="settings">
            <div class="status">
                <div class="status-dot"></div>
                Scramjet Engine Active
            </div>
            <div class="status">
                v1.5.4-GH
            </div>
            <div class="status">
                Wisp: <span id="wisp-display">anura.pro</span>
            </div>
        </div>
    </div>

    <!-- Proxy Overlay (Mini Browser) -->
    <div id="proxy-overlay">
        <div class="browser-toolbar">
            <div class="nav-controls">
                <button class="nav-btn" title="Back" onclick="goBack()">‚Üê</button>
                <button class="nav-btn" title="Forward" onclick="goForward()">‚Üí</button>
                <button class="nav-btn" title="Reload" onclick="reloadPage()">‚Üª</button>
            </div>

            <div class="address-bar-container">
                <span class="url-icon">üîí</span>
                <input type="text" class="browser-input" id="browser-address-bar" placeholder="Search or enter URL"
                    onkeyup="if(event.key === 'Enter') navigateToUrl()">
            </div>

            <button class="nav-btn" title="Fix Login/Google Issues" style="color: #fbd38d;" onclick="syncIdentity()">üîë
                Sync</button>
            <button class="exit-btn" onclick="closeProxy()">Exit</button>
        </div>
        <div id="iframe-container"></div>
    </div>

    <script>
        let activeFrame = null;

        // --- GITHUB PAGES PATH FIX ---
        // Detect if we are in a subdirectory (like /zxs-test-proxy/)
        const isGH = location.hostname.includes('github.io');
        const pathSegments = window.location.pathname.split('/').filter(s => s);
        const repoName = isGH ? pathSegments[0] : '';
        // BareMux requires paths to start with / or be absolute
        const root = isGH ? `/${repoName}/` : '/';

        function handleError(msg) {
            console.error(msg);
            const sub = document.querySelector('.subtitle');
            if (sub) sub.innerHTML = `<span style="color:#ef4444; font-weight:bold;">ERROR: ${msg}</span>`;
        }

        console.log("Detected Root Path:", root);

        const { ScramjetController } = $scramjetLoadController();
        const scramjet = new ScramjetController({
            files: {
                wasm: `${root}scram/scramjet.wasm.wasm`,
                all: `${root}scram/scramjet.all.js`,
                sync: `${root}scram/scramjet.sync.js`,
            },
        });

        console.log("Initializing Scramjet...");
        try {
            scramjet.init();
        } catch (e) { handleError("Scramjet Init Failed: " + e.message); }

        if ('serviceWorker' in navigator) {
            // Note: serviceWorker.register ALSO needs a root-relative path
            navigator.serviceWorker.register(`${root}sw.js`).then(() => console.log("Service Worker Registered Successfully"))
                .catch(err => handleError("Service Worker Registration Failed: " + err));
        }

        console.log("Connecting to BareMux...");
        const connection = new BareMux.BareMuxConnection(`${root}baremux/worker.js`);

        const wispServers = [
            "wss://anura.pro/",
            "wss://wisp.mercurywork.shop/wisp/",
            "wss://gointospace.app/wisp/"
        ];

        const wispUrl = localStorage.getItem("proxServer") || wispServers[0];
        document.getElementById('wisp-display').innerText = new URL(wispUrl).hostname;

        connection.setTransport(`${root}epoxy/index.mjs`, [{ wisp: wispUrl }])
            .then(() => console.log("BareMux Transport Set to:", wispUrl))
            .catch(err => handleError("BareMux Transport Failed: " + err));

        function launchProxy() {
            const url = document.getElementById('url-input').value;
            launchUrl(url);
        }

        function launchUrl(url) {
            if (!url || url.trim() === "") return;
            if (!url.startsWith('http')) url = 'https://' + url;

            document.getElementById('proxy-overlay').style.display = 'flex';
            document.getElementById('browser-address-bar').value = url;

            const container = document.getElementById('iframe-container');
            container.innerHTML = '';

            console.log("Creating Scramjet Frame...");
            activeFrame = scramjet.createFrame();
            container.appendChild(activeFrame.frame);

            activeFrame.frame.style.width = '100%';
            activeFrame.frame.style.height = '100%';
            activeFrame.frame.style.border = 'none';

            // Sync URL bar when navigating within the iframe
            activeFrame.addEventListener("urlchange", (e) => {
                if (e.url) {
                    document.getElementById('browser-address-bar').value = e.url;
                }
            });

            console.log("Navigating Frame to:", url);
            activeFrame.go(url);
        }

        function navigateToUrl() {
            const url = document.getElementById('browser-address-bar').value;
            if (activeFrame) {
                let target = url;
                if (!target.startsWith('http') && target.includes('.')) {
                    target = 'https://' + target;
                } else if (!target.startsWith('http')) {
                    target = 'https://www.google.com/search?q=' + encodeURIComponent(target);
                }
                activeFrame.go(target);
            }
        }

        function goBack() {
            if (activeFrame) activeFrame.back();
        }

        function goForward() {
            if (activeFrame) activeFrame.forward();
        }

        function reloadPage() {
            if (activeFrame) activeFrame.reload();
        }

        function syncIdentity() {
            // Open a proxied Google login window directly
            // This bypasses the 'blocked' issue by using the proxy to reach the page, 
            // but opens it in a new tab to avoid iframe detection.
            const googleLogin = "https://accounts.google.com/ServiceLogin?hl=en";
            const proxiedUrl = scramjet.encodeUrl(googleLogin);
            const win = window.open(proxiedUrl, "_blank", "width=800,height=700");

            alert("A stealth login window has opened. Sign in to your Google Account there, then come back here and RELOAD the game.");
        }

        function closeProxy() {
            if (confirm("Close the stealth browser?")) {
                document.getElementById('proxy-overlay').style.display = 'none';
                const container = document.getElementById('iframe-container');
                container.innerHTML = '';
                activeFrame = null;
            }
        }
    </script>

</body>

</html>